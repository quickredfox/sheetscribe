<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>}</title>
	<link rel="stylesheet" type="text/css" media="screen" href="css/master.css" />
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
	<!--[if IE]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<script type="text/javascript" charset="utf-8">
			// Fixes jquery injects for IE
			window.innerShiv=(function(){var d,r;return function(h,u){if(!d){d=document.createElement('div');r=document.createDocumentFragment();}
			var e=d.cloneNode(true);e.innerHTML=h;if(u===false)return e.childNodes;var f=r.cloneNode(true),i=e.childNodes.length;while(i--)f.appendChild(e.firstChild);return f;}}());$.each(['after','before','append','prepend','replaceWith'],function(index,fnName){$.fn['_old_'+fnName]=$.fn[fnName];$.fn[fnName]=function(h){if(typeof h=='string')
			return $.fn['_old_'+fnName].call(this,innerShiv(h));else return $.fn['_old_'+fnName].apply(this,arguments);};});
		</script>
	<![endif]-->
	<script type="text/javascript" charset="utf-8">
	RegExp.customEscape = function(text) {
	    if (!arguments.callee.sRE) {
	        var specials = [
	        '/', '.', '*', '+', '?', '|',
	        '(', ')', '[', ']', '{', '}', '\\',
	        '@', '^', '%', '#', '&', '$'
	        ];
	        arguments.callee.sRE = new RegExp(
	        '(\\' + specials.join('|\\') + ')', 'g'
	        );
	    }
	    return text.replace(arguments.callee.sRE, '\\$1');
	}

	/*
	      Splits a string 2-ways along delimiter.
	      Delimiter can be a regex or a string.
	      Returns an array with [before,after]
	*/
	String.prototype.bisect = function(delimiter) {
	    var re = new RegExp();
	    var esc = RegExp.customEscape(delimiter);
	    re.compile(esc + "(.+)");
	    return this.split(re, 2)
	};
	if (!Array.prototype.map)
	{
	  Array.prototype.map = function(fun /*, thisp*/)
	  {
	    var len = this.length >>> 0;
	    if (typeof fun != "function")
	      throw new TypeError();

	    var res = new Array(len);
	    var thisp = arguments[1];
	    for (var i = 0; i < len; i++)
	    {
	      if (i in this)
	        res[i] = fun.call(thisp, this[i], i, this);
	    }

	    return res;
	  };
	}
	
	var hashid=0;
	var hash = function(obj) {
		return obj._hash ? obj._hash : (obj._hash = (++hashid+(new Date())));
	}
	var FMATCH="$1",LCURL = '{',RCURL='}',DRCURL='}}',EMPTY='',COLON=':',SEMI=';',SPC=' ';

	    function clean(css) {
	        clean.RE.forEach(function(re) {
	            css = css.replace(re[0],re[1]);
	        })
	        return css;
	    };
	    clean.RE = [
	     [(/\/\*[^*]*\*+([^\/*][^*]*\*+)*\//g),EMPTY], // strip out comments and extra linebreaks/whitespace
	     [(/([\r\n\t\s]){1,}/gm),FMATCH],              // strip out multiple whitespace
		[(/[\n\t\s\r]*([\{\;\:\}])[\n\t\s\r]*/g), FMATCH],
	     [(/([^\}\;])\}/g),FMATCH+";}"]                // bring back optional last semicolon
	    ];
		function munge(css,extracted, results) {
			var extracted = extracted||munge.extractMedias(css);
			results = results||{};
			extracted.forEach(function(blk,index) {
				var selectors = {};
				munge.stripCurlies(blk).match(/([^\}]+)\{([^\}])+\}/g).forEach(function(m) {
					munge.addSelector(m.trim(),selectors);
				});
				blk.match(/\@media([^\{]+)/)[1].split(',').forEach(function(n,i,a) {
					var name = n.trim();
					if(!results[name]){results[name]=[]};
					// parse selectors within block
					results[name].push(selectors);
				});
			})
			return results;
		};
		munge.stripCurlies = function(str) {
			return str.substring(str.indexOf(LCURL)+1,str.lastIndexOf(RCURL));
		}
		munge.addSelector = function(str,obj) {
			return obj[str.substring(0,str.indexOf(LCURL))] = str.substring(str.indexOf(LCURL)+1,str.length-1);
		}
		munge.extractMedias = function(css) {
			var all=css=clean(css),medias = [],mat,ind,strt,end,blk;
			all = css.replace(/(\@media.+?\}\})/g,function(m) { medias.push(m);return ''});
			medias.push('@media all{'+all+'}');
			return medias;
		}
		
		var css = "\
	    @media dev, dev2 {\
	     #shouldbedev { trueness: true; }\
	     #shouldbedev2 { trueness: true; color:nice;}\
	    }\
	    body{\
	        mediaall: true;\
	    }\
	    body p {\
	        foo:bar;\
	    }\
	    @media screen {\
	        #shouldbescreen { trueness: true;} \
	    }\
	    h1{\
	        color:red;\
	    }\
	    @media dev {\
	        #shouldNOTbescreen { trueness: true;} \
	    }\
	    ";
	console.debug(munge(css))
	</script>
</head>
<body>

</body>
</html>